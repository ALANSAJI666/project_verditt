{% load static %}
{% extends 'base.html' %}

{% block content %}
  <h1>{{ conversation.name }}</h1>

  <div id="chatbox">
    {% for message in messages %}
      {% if message.sender == user %}
        <div class="message from-me">
          <span class="message-timestamp">{{ message.timestamp }}</span>
          {{ message.content }}
        </div>
      {% else %}
        <div class="message from-them">
          <span class="message-timestamp">{{ message.timestamp }}</span>
          <strong>{{ message.sender.username }}</strong>: {{ message.content }}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <form id="chat-form">
    <input type="text" name="message" placeholder="Type your message">
    <button type="submit">Send</button>
  </form>

  <script>
    var conversationId = "{{ conversation.id }}";
    var chatSocket = new WebSocket(
      'ws://' + window.location.host +
      '/ws/conversation/' + conversationId + '/');

    chatSocket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var messageElement = document.createElement('div');

      if (data.sender == "{{ user.username }}") {
        messageElement.className = 'message from-me';
        messageElement.innerHTML = '<span class="message-timestamp">' +
          data.timestamp + '</span>' + data.content;
      } else {
        messageElement.className = 'message from-them';
        messageElement.innerHTML = '<span class="message-timestamp">' +
          data.timestamp + '</span><strong>' + data.sender + '</strong>: ' + data.content;
      }

      document.querySelector('#chatbox').appendChild(messageElement);
    };

    document.querySelector('#chat-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var messageInputDom = document.querySelector('#chat-form input[name="message"]');
      var message = messageInputDom.value;
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInputDom.value = '';
    });
  </script>
{% endblock %}
